<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Establecimiento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .detail-item { margin-bottom: 10px; }
        .detail-item strong { display: inline-block; width: 150px; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .back-button { margin-top: 20px; padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
        .back-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <a href="/dashboard" class="back-button">Volver al Panel</a>
    <h1 id="establishmentName">Cargando Detalles del Establecimiento...</h1>
    
    <h2>Datos del Formulario</h2>
    <div id="formDataDisplay">
        <p>Cargando datos...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const establishmentId = urlParams.get('id');

            if (establishmentId) {
                loadEstablishmentDetails(establishmentId);
            } else {
                document.getElementById('establishmentName').textContent = 'Error: ID de establecimiento no proporcionado.';
                document.getElementById('formDataDisplay').innerHTML = '<p>No se pudo cargar la informaci贸n.</p>';
            }

            async function loadEstablishmentDetails(id) {
                try {
                    const response = await fetch(`/establishments/${id}`);
                    const establishment = await response.json();

                    document.getElementById('establishmentName').textContent = `Detalles de ${establishment.name || 'Establecimiento sin nombre'}`;
                    
                    const formDataDisplay = document.getElementById('formDataDisplay');
                    formDataDisplay.innerHTML = ''; // Clear loading text

                    // Display basic establishment data
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>ID:</strong> ${establishment.id}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Nombre:</strong> ${establishment.name || 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Email del Propietario:</strong> ${establishment.owner_email || 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>CUIT:</strong> ${establishment.cuit || 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Direcci贸n:</strong> ${establishment.address || 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Enlace de Pago:</strong> ${establishment.payment_link ? `<a href="${establishment.payment_link}" target="_blank">${establishment.payment_link}</a>` : 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Ruta PDF:</strong> ${establishment.pdf_path || 'N/A'}</div>`;
                    formDataDisplay.innerHTML += `<div class="detail-item"><strong>Fecha de Creaci贸n:</strong> ${new Date(establishment.created_at).toLocaleString() || 'N/A'}</div>`;

                    // Display parsed webhook data
                    if (establishment.webhook_data) {
                        try {
                            const webhookData = JSON.parse(establishment.webhook_data);
                            formDataDisplay.innerHTML += '<h3>Detalles del Webhook</h3>';
                            for (const key in webhookData) {
                                if (webhookData.hasOwnProperty(key)) {
                                    let displayValue = webhookData[key];
                                    if (typeof displayValue === 'object' && displayValue !== null) {
                                        displayValue = JSON.stringify(displayValue, null, 2);
                                        formDataDisplay.innerHTML += `<div class="detail-item"><strong>${key}:</strong> <pre>${displayValue}</pre></div>`;
                                    } else {
                                        formDataDisplay.innerHTML += `<div class="detail-item"><strong>${key}:</strong> ${displayValue}</div>`;
                                    }
                                }
                            }
                        } catch (e) {
                            formDataDisplay.innerHTML += `<div class="detail-item"><strong>Datos Webhook (raw):</strong> <pre>${establishment.webhook_data}</pre></div>`;
                            console.error("Error parsing webhook_data:", e);
                        }
                    } else {
                        formDataDisplay.innerHTML += `<div class="detail-item"><strong>Datos Webhook:</strong> N/A</div>`;
                    }

                } catch (error) {
                    console.error('Error fetching establishment details:', error);
                    document.getElementById('establishmentName').textContent = 'Error al cargar los detalles.';
                    document.getElementById('formDataDisplay').innerHTML = `<p>No se pudo cargar la informaci贸n detallada para el ID ${id}.</p>`;
                }
            }
        });
    </script>
</body>
</html>