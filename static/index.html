<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Caza 2026</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; position: sticky; top: 0; }
        .action-button { margin-right: 5px; padding: 5px 10px; cursor: pointer; }
        .view-toggle { margin-bottom: 20px; }
        .view-toggle button { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background-color: #f0f0f0; }
        .view-toggle button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .table-container { display: none; }
        .table-container.active { display: block; }
        .table-wrapper { max-height: 70vh; overflow: auto; }
    </style>
</head>
<body>
    <h1>Panel de Registro de Establecimientos - Sistema Caza 2026</h1>

    <div class="view-toggle">
        <button id="btn-summary" class="active" onclick="showView('summary')">Vista Resumida</button>
        <button id="btn-full" onclick="showView('full')">Vista Detallada (Hoja de Cálculo)</button>
        <button onclick="location.reload()">Refrescar Datos</button>
    </div>

    <!-- Vista Resumida -->
    <div id="summary-view" class="table-container active">
        <div class="table-wrapper">
            <table id="establishmentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email del Propietario</th>
                        <th>CUIT</th>
                        <th>Dirección</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Vista Detallada -->
    <div id="full-view" class="table-container">
         <div class="table-wrapper">
            <table id="fullDataTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar la vista resumida por defecto
            loadSummaryData();
        });

        function showView(viewName) {
            document.getElementById('summary-view').classList.remove('active');
            document.getElementById('full-view').classList.remove('active');
            document.getElementById('btn-summary').classList.remove('active');
            document.getElementById('btn-full').classList.remove('active');

            document.getElementById(`${viewName}-view`).classList.add('active');
            document.getElementById(`btn-${viewName}`).classList.add('active');

            if (viewName === 'full') {
                loadFullData();
            } else {
                loadSummaryData();
            }
        }

        async function loadSummaryData() {
            try {
                const response = await fetch('/establishments');
                const data = await response.json();
                const tableBody = document.getElementById('establishmentsTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = ''; // Clear existing rows
                
                data.forEach(establishment => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = establishment.id;
                    row.insertCell().textContent = establishment.name;
                    row.insertCell().textContent = establishment.owner_email;
                    row.insertCell().textContent = establishment.cuit;
                    row.insertCell().textContent = establishment.address;
                    
                    const actionsCell = row.insertCell();

                    const pdfButton = document.createElement('button');
                    pdfButton.textContent = "Ver PDF";
                    pdfButton.className = "action-button";
                    if (establishment.pdf_path) {
                        pdfButton.onclick = () => window.open(`/${establishment.pdf_path}`, '_blank');
                    } else {
                        pdfButton.disabled = true;
                    }
                    actionsCell.appendChild(pdfButton);
                });
            } catch (error) {
                console.error('Error fetching summary establishments:', error);
            }
        }

        async function loadFullData() {
            try {
                const response = await fetch('/establishments/full');
                const data = await response.json();
                const table = document.getElementById('fullDataTable');
                const thead = table.getElementsByTagName('thead')[0];
                const tbody = table.getElementsByTagName('tbody')[0];
                
                thead.innerHTML = '';
                tbody.innerHTML = '';

                if (data.length === 0) {
                    thead.innerHTML = '<tr><th>No hay datos para mostrar</th></tr>';
                    return;
                }

                const allKeys = new Set();
                const processedData = [];

                data.forEach(record => {
                    let fullRecord = {
                        id: record.id,
                        nombre_establecimiento: record.name,
                        email_propietario: record.owner_email,
                        cuit: record.cuit,
                        direccion: record.address,
                        pdf_path: record.pdf_path,
                        fecha_registro: record.created_at
                    };

                    if (record.webhook_data) {
                        const webhookData = JSON.parse(record.webhook_data);
                        // Limpiar llaves internas de Fluent Forms
                        delete webhookData._fluentform_9_fluentformnonce;
                        delete webhookData.__submission;
                        Object.assign(fullRecord, webhookData);
                    }
                    
                    processedData.push(fullRecord);
                    Object.keys(fullRecord).forEach(key => allKeys.add(key));
                });

                const sortedKeys = Array.from(allKeys).sort();

                // Crear encabezado
                const headerRow = document.createElement('tr');
                sortedKeys.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Crear filas de datos
                processedData.forEach(record => {
                    const row = document.createElement('tr');
                    sortedKeys.forEach(key => {
                        const td = document.createElement('td');
                        let value = record[key];
                        if (Array.isArray(value)) {
                            td.textContent = value.join(', ');
                        } else {
                            td.textContent = value !== null && value !== undefined ? value : '';
                        }
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching full data:', error);
            }
        }
    </script>
</body>
</html>